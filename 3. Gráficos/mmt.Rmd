---
title: "MMT"
date: "Julho de 2023"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

```{r setup, include=FALSE}
# Carregar pacotes ----

library(tidyverse)
library(readr)
library(plotly)
library(treemapify)

quebra <- function(coluna, numPalavras) {
  colunaNova <- character(length(coluna))  # Vetor vazio para armazenar os valores da coluna modificada
  
  for (i in seq_along(coluna)) {
    palavras <- strsplit(coluna[i], " ")[[1]]  # Dividir a célula da coluna em palavras
    resultado <- character(0)  # Vetor vazio para armazenar as palavras
    
    for (j in seq_along(palavras)) {
      resultado <- c(resultado, palavras[j])  # Adicionar cada palavra ao vetor resultado
      
      if (j %% numPalavras == 0 && j != length(palavras)) {
        resultado <- c(resultado, "\n")  # Inserir quebra de linha a cada numPalavras palavras
      }
    }
    
    colunaNova[i] <- paste(resultado, collapse = " ")  # Combinar as palavras novamente em uma única string e atribuir à coluna modificada
  }
  
  return(colunaNova)
}

`%notin%` <- Negate(`%in%`)           # Função de filtro
options(readr.show_col_types = FALSE) # Omitir formato das colunas no console

# Importação dos dados ----

dados_painel2 <- lapply(paste0("../2. Tratamento dos dados/Painel 2 - Remuneração e Ocupações/Resultados/", dir("../2. Tratamento dos dados/Painel 2 - Remuneração e Ocupações/Resultados")), read.csv2)
names(dados_painel2) <- c("ranking_CBO", "remun_media", "num_vinc", "rotatividade")

dados_painel3 <- lapply(paste0("../2. Tratamento dos dados/Painel 3 - Ocupações Técnicas/Resultados/", dir("../2. Tratamento dos dados/Painel 3 - Ocupações Técnicas/Resultados")), read.csv2)
names(dados_painel3) <- c("ocup_cbo", "ocup_emp", "ocup_eixo", "vinc")
```

# Painel 2 - remunerações e ocupações

## Ranking de CBOs

### Ganho de vínculos

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel2$ranking_CBO |>
   mutate(nome_cbo_familia = quebra(nome_cbo_familia, 4)) |>
   arrange(desc(variacao_vinculos)) |>
   slice(1:10) |>
   plot_ly(x = ~variacao_vinculos * 100) |>
   add_trace(y = ~nome_cbo_familia,
             type = "bar",
             color = I("#176180")) |>
   add_annotations(x = ~variacao_vinculos, 
                   y = ~nome_cbo_familia,
                   xanchor = "left",
                   yanchor = "rigth",
                   text = ~paste(round(variacao_vinculos * 100, 2), "%"),
                   textposition = "middle",
                   font = list(color = "white"),
                   showarrow = FALSE) |>
   config(displayModeBar = FALSE) |>
   layout(hovermode = "y",
          yaxis = list(title = "",
                       showgrid = FALSE,
                       showline = TRUE,
                       categoryorder = "total ascending"),
          xaxis = list(title = "",
                       hoverformat = ".1f",
                       showgrid = FALSE,
                       showline = TRUE,
                       ticksuffix = "%"),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "relative",
          uniformtext = list(minsize = 8,
                             mode = "hide"))
```

### Perda de vínculos

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel2$ranking_CBO |>
   mutate(nome_cbo_familia = quebra(nome_cbo_familia, 4)) |>
   arrange(variacao_vinculos) |>
   slice(1:10) |>
   plot_ly(x = ~variacao_vinculos * 100) |>
   add_trace(y = ~nome_cbo_familia,
             type = "bar",
             color = I("#f04933")) |>
   add_annotations(x = ~variacao_vinculos, 
                   y = ~nome_cbo_familia,
                   xanchor = "right",
                   yanchor = "rigth",
                   text = ~paste(round(variacao_vinculos * 100, 2), "%"),
                   textposition = "middle",
                   font = list(color = "white"),
                   showarrow = FALSE) |>
   config(displayModeBar = FALSE) |>
   layout(hovermode = "y",
          yaxis = list(title = "",
                       showgrid = FALSE,
                       showline = TRUE,
                       categoryorder = "total descending"),
          xaxis = list(title = "",
                       hoverformat = ".1f",
                       showgrid = FALSE,
                       showline = TRUE,
                       ticksuffix = "%"),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "relative",
          uniformtext = list(minsize = 8,
                             mode = "hide"))
```

### Ganho salarial

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel2$ranking_CBO |>
   mutate(nome_cbo_familia = quebra(nome_cbo_familia, 4)) |>
   arrange(desc(variacao_rendimento)) |>
   slice(1:10) |>
   plot_ly(x = ~variacao_rendimento * 100) |>
   add_trace(y = ~nome_cbo_familia,
             type = "bar",
             color = I("#176180")) |>
   add_annotations(x = ~variacao_rendimento, 
                   y = ~nome_cbo_familia,
                   xanchor = "left",
                   yanchor = "rigth",
                   text = ~paste(round(variacao_rendimento * 100, 2), "%"),
                   textposition = "middle",
                   font = list(color = "white"),
                   showarrow = FALSE) |>
   config(displayModeBar = FALSE) |>
   layout(hovermode = "y",
          yaxis = list(title = "",
                       showgrid = FALSE,
                       showline = TRUE,
                       categoryorder = "total ascending"),
          xaxis = list(title = "",
                       hoverformat = ".1f",
                       showgrid = FALSE,
                       showline = TRUE,
                       ticksuffix = "%"),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "relative",
          uniformtext = list(minsize = 8,
                             mode = "hide"))
```

### Perda salarial

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel2$ranking_CBO |>
   mutate(nome_cbo_familia = quebra(nome_cbo_familia, 4)) |>
   arrange(variacao_rendimento) |>
   slice(1:10) |>
   plot_ly(x = ~variacao_rendimento * 100) |>
   add_trace(y = ~nome_cbo_familia,
             type = "bar",
             color = I("#f04933")) |>
   add_annotations(x = ~variacao_rendimento, 
                   y = ~nome_cbo_familia,
                   xanchor = "right",
                   yanchor = "rigth",
                   text = ~paste(round(variacao_rendimento * 100, 2), "%"),
                   textposition = "middle",
                   font = list(color = "white"),
                   showarrow = FALSE) |>
   config(displayModeBar = FALSE) |>
   layout(hovermode = "y",
          yaxis = list(title = "",
                       showgrid = FALSE,
                       showline = TRUE,
                       categoryorder = "total descending"),
          xaxis = list(title = "",
                       hoverformat = ".1f",
                       showgrid = FALSE,
                       showline = TRUE,
                       ticksuffix = "%"),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "relative",
          uniformtext = list(minsize = 8,
                             mode = "hide"))
```

## Remuneração mediana - por escolaridade

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel2$remun_media |>
   select(-c(salario_mes, filtro, geral)) |>
   pivot_wider(names_from = tipo,
               values_from = salario_hora) |>
   plot_ly(x = ~ano) |>
   add_trace(y = ~Analfabeto,
             type = "bar",
             name = "Analfabeto",
             color = I("#d92335")) |>
   add_trace(y = ~`Até fundamental completo`,
             type = "bar",
             name = "Até fundamental completo",
             color = I("#064471")) |>
   add_trace(y = ~`Até médio completo`,
             type = "bar",
             name = "Até médio completo",
             color = I("#bd3928")) |>
   add_trace(y = ~`Superior completo*`,
             type = "bar",
             name = "Superior completo",
             color = I("#f87d28")) |>
   config(displayModeBar = FALSE) %>%
   layout(hovermode = "x",
          yaxis = list(title = "",
                       tickprefix = "R$", 
                       hoverformat = '.1f',
                       showgrid = FALSE,
                       showline = TRUE),
          xaxis = list(title = "",
                       tickformat = "%Y",
                       tickmode = "array",
                       tickvals = c(min(dados_painel2$remun_media$ano):max(dados_painel2$remun_media$ano)),
                       showgrid = FALSE,
                       showline = TRUE),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "group")
```

## Remuneração mediana - por vínculos

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel2$remun_media |>
   select(-c(salario_mes, filtro, geral)) |>
   pivot_wider(names_from = tipo,
               values_from = salario_hora) |>
   plot_ly(x = ~ano) |>
   add_trace(y = ~`Trabalhadores técnicos`,
             type = "bar",
             name = "Trabalhadores técnicos",
             color = I("#fb8e80")) |>
   add_trace(y = ~`Técnicos de nível médio`,
             type = "bar",
             name = "Técnicos de nível médio",
             color = I("#818589")) |>
   add_trace(y = ~`Técnicos de nível superior`,
             type = "bar",
             name = "Técnicos de nível superior",
             color = I("#2b597a")) |>
   config(displayModeBar = FALSE) %>%
   layout(hovermode = "x",
          yaxis = list(title = "",
                       tickprefix = "R$", 
                       hoverformat = '.1f',
                       showgrid = FALSE,
                       showline = TRUE),
          xaxis = list(title = "",
                       tickformat = "%Y",
                       tickmode = "array",
                       tickvals = c(min(dados_painel2$remun_media$ano):max(dados_painel2$remun_media$ano)),
                       showgrid = FALSE,
                       showline = TRUE),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "group")
```

## Número de vínculos

### Número absoluto por escolaridade

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel2$num_vinc |>
   pivot_wider(names_from = tipo,
               values_from = vinculos) |>
   plot_ly(x = ~ano) |>
   add_trace(y = ~Analfabeto,
             type = "scatter", 
             mode = "lines+markers",
             name = "Analfabeto",
             color = I("#d92335")) |>
   add_trace(y = ~`Até fundamental completo`,
             type = "scatter", 
             mode = "lines+markers",
             name = "Até fundamental completo",
             color = I("#064471")) |>
   add_trace(y = ~`Médio completo`,
             type = "scatter", 
             mode = "lines+markers",
             name = "Médio completo",
             color = I("#bd3928")) |>
   add_trace(y = ~`Superior completo`,
             type = "scatter", 
             mode = "lines+markers",
             name = "Superior completo",
             color = I("#bdd928")) |>
   config(displayModeBar = FALSE) |>
   layout(hovermode = "x",
          yaxis = list(title = "",
                       hoverformat = ".0f",
                       showgrid = FALSE,
                       showline = TRUE),
          xaxis = list(title = "",
                       tickformat = "%Y",
                       tickmode = "array",
                       tickvals = c(min(dados_painel2$num_vinc$ano):max(dados_painel2$num_vinc$ano)),
                       showgrid = FALSE,
                       showline = TRUE),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "group")
```

### Número absoluto por atividade

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel2$num_vinc |>
   pivot_wider(names_from = tipo,
               values_from = vinculos) |>
   plot_ly(x = ~ano) |>
   add_trace(y = ~`Técnico de nível médio`,
             type = "scatter", 
             mode = "lines+markers",
             name = "Técnicos de nível médio",
             color = I("#065411")) |>
   add_trace(y = ~`Técnico de nível superior`,
             type = "scatter", 
             mode = "lines+markers",
             name = "Técnicos de nível superior",
             color = I("#cabd28")) |>
   config(displayModeBar = FALSE) |>
   layout(hovermode = "x",
          yaxis = list(title = "",
                       hoverformat = ".0f",
                       showgrid = FALSE,
                       showline = TRUE),
          xaxis = list(title = "",
                       tickformat = "%Y",
                       tickmode = "array",
                       tickvals = c(min(dados_painel2$num_vinc$ano):max(dados_painel2$num_vinc$ano)),
                       showgrid = FALSE,
                       showline = TRUE),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "group")
```

## Taxa de rotatividade

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel2$rotatividade |>
   select(-c(filtro, n_trabalhadores:desligados)) |>
   mutate(rotatividade = rotatividade * 100) |>
   pivot_wider(names_from = tipo,
               values_from = rotatividade) |>
   plot_ly(x = ~anodeclarado) |>
   add_trace(y = ~`Até fundamental completo`,
             type = "scatter", 
             mode = "lines+markers",
             name = "Até fundamental completo",
             color = I("#d92335")) |>
   add_trace(y = ~`Média dos trabalhadores não técnicos`,
             type = "scatter", 
             mode = "lines+markers",
             name = "Média dos trabalhadores não técnicos",
             color = I("#064471")) |>
   add_trace(y = ~`Média dos trabalhadores técnicos`,
             type = "scatter", 
             mode = "lines+markers",
             name = "Média dos trabalhadores técnicos",
             color = I("#bd3928")) |>
   add_trace(y = ~`Médio completo`,
             type = "scatter", 
             mode = "lines+markers",
             name = "Médio completo",
             color = I("#f87d28")) |>
   add_trace(y = ~`Superior completo`,
             type = "scatter", 
             mode = "lines+markers",
             name = "Superior completo",
             color = I("#0a78c7")) |>
   add_trace(y = ~`Técnicos de nível médio`,
             type = "scatter", 
             mode = "lines+markers",
             name = "Técnicos de nível médio",
             color = I("#fb8e80")) |>
   add_trace(y = ~`Técnicos de nível superior`,
             type = "scatter", 
             mode = "lines+markers",
             name = "Técnicos de nível superior",
             color = I("#2b597a")) |>
   config(displayModeBar = FALSE) |>
   layout(hovermode = "x",
          yaxis = list(title = "",
                       ticksuffix = "%",
                       hoverformat = ".2f",
                       showgrid = FALSE,
                       showline = TRUE),
          xaxis = list(title = "",
                       tickformat = "%Y",
                       tickmode = "array",
                       tickvals = c(min(dados_painel2$rotatividade$ano):max(dados_painel2$rotatividade$ano)),
                       showgrid = FALSE,
                       showline = TRUE),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "group")
```

# Painel 3 - ocupações técnicas

## Ocupações para empresas

### Exemplo 1: Bombeiro Civil

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel3$ocup_cbo |>
   group_by(nome_cbo_ocupacao, nome_cnae_classe) |>
   summarise(vinculos = sum(vinculos),
             .groups = "keep") |>
   ungroup() |>
   arrange(desc(vinculos), nome_cbo_ocupacao) |>
   filter(nome_cbo_ocupacao == "Bombeiro civil") |>
   slice(1:15) |>
   plot_ly(x = ~vinculos) |>
   add_trace(y = ~nome_cnae_classe,
             type = "bar",
             color = I("#176180")) |>
   add_annotations(x = ~vinculos,
                   y = ~nome_cnae_classe,
                   xanchor = "left",
                   yanchor = "rigth",
                   text = ~round(vinculos, 1),
                   textposition = "middle",
                   font = list(color = "white"),
                   showarrow = FALSE) |>
   config(displayModeBar = FALSE) |>
   layout(title = paste("Gráfico para CBO:", "Bombeiro civil"),
          hovermode = "y",
          yaxis = list(title = "",
                       showgrid = FALSE,
                       showline = TRUE,
                       categoryorder = "total ascending"),
          xaxis = list(title = "",
                       hoverformat = ".1f",
                       showgrid = FALSE,
                       showline = TRUE),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "relative",
          uniformtext = list(minsize = 8,
                             mode = "hide"))
```

### Exemplo 2: Diretor comercial

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel3$ocup_cbo |>
   group_by(nome_cbo_ocupacao, nome_cnae_classe) |>
   summarise(vinculos = sum(vinculos),
             .groups = "keep") |>
   ungroup() |>
   arrange(desc(vinculos), nome_cbo_ocupacao) |>
   filter(nome_cbo_ocupacao == "Diretor comercial") |>
   slice(1:15) |>
   plot_ly(x = ~vinculos) |>
   add_trace(y = ~nome_cnae_classe,
             type = "bar",
             color = I("#176180")) |>
   add_annotations(x = ~vinculos,
                   y = ~nome_cnae_classe,
                   xanchor = "left",
                   yanchor = "rigth",
                   text = ~round(vinculos, 1),
                   textposition = "middle",
                   font = list(color = "white"),
                   showarrow = FALSE) |>
   config(displayModeBar = FALSE) |>
   layout(title = paste("Gráfico para CBO:", "Diretor comercial"),
          hovermode = "y",
          yaxis = list(title = "",
                       showgrid = FALSE,
                       showline = TRUE,
                       categoryorder = "total ascending"),
          xaxis = list(title = "",
                       hoverformat = ".1f",
                       showgrid = FALSE,
                       showline = TRUE),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "relative",
          uniformtext = list(minsize = 8,
                             mode = "hide"))
```


### Exemplo 3: Assistente administrativo

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel3$ocup_cbo |>
   group_by(nome_cbo_ocupacao, nome_cnae_classe) |>
   summarise(vinculos = sum(vinculos),
             .groups = "keep") |>
   ungroup() |>
   arrange(desc(vinculos), nome_cbo_ocupacao) |>
   filter(nome_cbo_ocupacao == "Assistente administrativo") |>
   slice(1:15) |>
   plot_ly(x = ~vinculos) |>
   add_trace(y = ~nome_cnae_classe,
             type = "bar",
             color = I("#176180")) |>
   add_annotations(x = ~vinculos,
                   y = ~nome_cnae_classe,
                   xanchor = "left",
                   yanchor = "rigth",
                   text = ~round(vinculos, 1),
                   textposition = "middle",
                   font = list(color = "white"),
                   showarrow = FALSE) |>
   config(displayModeBar = FALSE) |>
   layout(title = paste("Gráfico para CBO:", "Assistente administrativo"),
          hovermode = "y",
          yaxis = list(title = "",
                       showgrid = FALSE,
                       showline = TRUE,
                       categoryorder = "total ascending"),
          xaxis = list(title = "",
                       hoverformat = ".1f",
                       showgrid = FALSE,
                       showline = TRUE),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "relative",
          uniformtext = list(minsize = 8,
                             mode = "hide"))
```

## Empresas para ocupações

### Exemplo 1: Administração pública em geral

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel3$ocup_emp |>
   group_by(nome_cnae_subclasse, nome_cbo_familia) |>
   summarise(vinculos = sum(vinculos),
             .groups = "keep") |>
   ungroup() |>
   arrange(desc(vinculos), nome_cbo_familia) |>
   filter(nome_cnae_subclasse == "Administração pública em geral") |>
   slice(1:15) |>
   plot_ly(x = ~vinculos) |>
   add_trace(y = ~nome_cbo_familia,
             type = "bar",
             color = I("#176180")) |>
   add_annotations(x = ~vinculos,
                   y = ~nome_cbo_familia,
                   xanchor = "left",
                   yanchor = "rigth",
                   text = ~round(vinculos, 1),
                   textposition = "middle",
                   font = list(color = "white"),
                   showarrow = FALSE) |>
   config(displayModeBar = FALSE) |>
   layout(title = paste("Gráfico para CNAE:", "Administração pública em geral"),
          hovermode = "y",
          yaxis = list(title = "",
                       showgrid = FALSE,
                       showline = TRUE,
                       categoryorder = "total ascending"),
          xaxis = list(title = "",
                       hoverformat = ".1f",
                       showgrid = FALSE,
                       showline = TRUE),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "relative",
          uniformtext = list(minsize = 8,
                             mode = "hide"))
```

### Exemplo 2: Restaurantes e similares

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel3$ocup_emp |>
   group_by(nome_cnae_subclasse, nome_cbo_familia) |>
   summarise(vinculos = sum(vinculos),
             .groups = "keep") |>
   ungroup() |>
   arrange(desc(vinculos), nome_cbo_familia) |>
   filter(nome_cnae_subclasse == "Restaurantes e similares") |>
   slice(1:15) |>
   plot_ly(x = ~vinculos) |>
   add_trace(y = ~nome_cbo_familia,
             type = "bar",
             color = I("#176180")) |>
   add_annotations(x = ~vinculos,
                   y = ~nome_cbo_familia,
                   xanchor = "left",
                   yanchor = "rigth",
                   text = ~round(vinculos, 1),
                   textposition = "middle",
                   font = list(color = "white"),
                   showarrow = FALSE) |>
   config(displayModeBar = FALSE) |>
   layout(title = paste("Gráfico para CNAE:", "Restaurantes e similares"),
          hovermode = "y",
          yaxis = list(title = "",
                       showgrid = FALSE,
                       showline = TRUE,
                       categoryorder = "total ascending"),
          xaxis = list(title = "",
                       hoverformat = ".1f",
                       showgrid = FALSE,
                       showline = TRUE),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "relative",
          uniformtext = list(minsize = 8,
                             mode = "hide"))
```

### Exemplo 3: Frigorífico - abate de bovinos

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}


dados_painel3$ocup_emp |>
   group_by(nome_cnae_subclasse, nome_cbo_familia) |>
   summarise(vinculos = sum(vinculos),
             .groups = "keep") |>
   ungroup() |>
   arrange(desc(vinculos), nome_cbo_familia) |>
   filter(nome_cnae_subclasse == "Frigorífico - abate de bovinos") |>
   slice(1:15) |>
   plot_ly(x = ~vinculos) |>
   add_trace(y = ~nome_cbo_familia,
             type = "bar",
             color = I("#176180")) |>
   add_annotations(x = ~vinculos,
                   y = ~nome_cbo_familia,
                   xanchor = "left",
                   yanchor = "rigth",
                   text = ~round(vinculos, 1),
                   textposition = "middle",
                   font = list(color = "white"),
                   showarrow = FALSE) |>
   config(displayModeBar = FALSE) |>
   layout(title = paste("Gráfico para CNAE:", "Frigorífico - abate de bovinos"),
          hovermode = "y",
          yaxis = list(title = "",
                       showgrid = FALSE,
                       showline = TRUE,
                       categoryorder = "total ascending"),
          xaxis = list(title = "",
                       hoverformat = ".1f",
                       showgrid = FALSE,
                       showline = TRUE),
          legend = list(orientation = "h",
                        title = list(text = "")),
          barmode = "relative",
          uniformtext = list(minsize = 8,
                             mode = "hide"))
```

## Ocupações e eixos tecnológicos

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(15,40)}

plots <- list()

for (i in 1:13) {
   dados_filtrados <- dados_painel3$ocup_eixo %>%
       mutate(nome_cbo_familia = quebra(nome_cbo_familia,4)) %>%
       filter(eixo == unique(dados_painel3$ocup_eixo$eixo)[i]) %>%
       arrange(desc(vinculos), nome_cbo_familia) %>%
       slice(1:10)
   
   plot <- plot_ly(dados_filtrados, x = ~vinculos, y = ~nome_cbo_familia, type = "bar", color = I("#62a69c")) %>%
       layout(title = paste("Gráfico para Eixo:", unique(dados_painel3$ocup_eixo$eixo)[i]),
              hovermode = "y",
              yaxis = list(title = "",
                           showgrid = FALSE,
                           showline = TRUE,
                           categoryorder = "total ascending"),
              xaxis = list(title = "",
                           hoverformat = ".1f",
                           showgrid = FALSE,
                           showline = TRUE),
              legend = list(orientation = "h",
                            title = list(text = "")),
              barmode = "relative",
              uniformtext = list(minsize = 8,
                                 mode = "hide"))
   
   plots[[i]] <- plot
}

subplot(plots, 
        nrows = 7,
        margin = c(.1,.1,.01,.01))
```



## Remuneração e vínculos

```{r, include=TRUE,echo=FALSE,warning=FALSE,results='asis',fig.align = 'center',fig.dim=c(10,6)}
dados_painel3$vinc |>
   select(cbo_familia,nome_cbo_familia,
          variacao_rendimento,
          variacao_vinculos) |>
   mutate(cat = case_when(variacao_vinculos > 0 & variacao_rendimento > 0 ~ "A",
                          variacao_vinculos < 0 & variacao_rendimento < 0 ~ "B",
                          TRUE ~ "C"),
          variacao_vinculos = round(variacao_vinculos,3),
          variacao_rendimento = round(variacao_rendimento,3)) |> 
   filter(abs(variacao_vinculos) < 1,
          abs(variacao_rendimento) < 1) |>
   plot_ly(x = ~variacao_rendimento * 100,
          y = ~variacao_vinculos * 100,
          color = ~cat,
          colors = c("#0a78c7","#d92335","#fb8e80"),
          text = ~nome_cbo_familia, 
          type = 'scatter', 
          mode = 'markers',
          marker = list(size = 25,opacity = 0.4)) |> 
   config(displayModeBar = FALSE) |>
   layout(yaxis = list(title = "Variação Vínculos",
                       ticksuffix = "%",
                       range=c(-50, 50)),
          xaxis = list(title = "Variação Rendimentos",
                       ticksuffix = "%",
                       range=c(-50, 50)),
          legend = list(orientation = "h",
                        title = list(text = "")))
```
