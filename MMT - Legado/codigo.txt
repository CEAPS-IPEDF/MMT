# Cria base de dados da RAIS com as considerações do Panorama

# Configuração inicial ----
## Carrega pacotes ----
##install.packages("RODBC")
library(dplyr)
library(odbc)
library(stringr)
library(RODBC)
library(data.table)

## Carrega arquivos ----
cbotecnica_nivel_medio = data.table::fread("dados/cbotecnica_nivelmedio.csv", header = TRUE)
cbotecnica_nivel_superior = data.table::fread("dados/cbotecnica_nivelsuperior.csv", header = TRUE)
ocupacoes_protegidas = data.table::fread("dados/ocupacoes_protegidas.csv", header = TRUE)
eixos = lapply(paste0('dados/', dir('dados')[str_detect(dir('dados'), "Eixo[0-9]{1,2}\\.")]), function(x) {data.table::fread(x, encoding = "UTF-8", sep = ';')})
eixos_superior = lapply(paste0('dados/', dir('dados')[str_detect(dir('dados'), "Eixo[0-9]{1,2}\\_")]), function(x) {data.table::fread(x)})


## Colocan omes em eixos
names(eixos) = vapply(eixos, function(x){names(x)[[2]]}, 'eixo')
names(eixos_superior) = vapply(eixos_superior, function(x){names(x)[[2]]}, 'eixo')

## Carrega arquivo do inpc do df ----

serie_inpc = readxl::read_excel("dados/serie_inpcDF.xlsx")

# Conecta a base de dados ----

db <- RODBC::odbcConnect("db_codeplan", uid=("TEU LOGIN"), pwd=("TUA SENHA"))


dados <- RODBC::sqlQuery(db, "SELECT referencia, vinculoativo3112, tipovinculo, escolaridade_2006_atual as escolaridade, sexotrabalhador, racacor, vlremdeznm as vlremundezembronom, vlremdezsm as vlremundezembrosm, tiposal as tiposalario, tempoemprego, qtdhoracontr, vl_salario_contrato as vlsalariocontratual, cbo2002 as cboocupacao2002, cnae20subclasse, idade, null as indtrabintermitente  FROM rais_id.vinc_2011 WHERE municipio = 530010 and vinculoativo3112 = 1
                                 union all
                                 SELECT referencia, vinculoativo3112, tipovinculo, escolaridade_2006_atual as escolaridade, sexotrabalhador, racacor, vlremdeznm as vlremundezembronom, vlremdezsm as vlremundezembrosm, tiposal as tiposalario, tempoemprego, qtdhoracontr, vl_salario_contrato as vlsalariocontratual, cbo2002 as cboocupacao2002, cnae20subclasse, idade, null as indtrabintermitente  FROM rais_id.vinc_2012 WHERE municipio = 530010 and vinculoativo3112 = 1
                                 union all
                                 SELECT referencia, vinculoativo3112, tipovinculo, escolaridade_2006_atual as escolaridade, sexotrabalhador, racacor, vlremdeznm as vlremundezembronom, vlremdezsm as vlremundezembrosm, tiposal as tiposalario, tempoemprego, qtdhoracontr, vl_salario_contrato as vlsalariocontratual, cbo2002 as cboocupacao2002, cnae20subclasse, idade, null as indtrabintermitente  FROM rais_id.vinc_2013 WHERE municipio = 530010 and vinculoativo3112 = 1
                                 union all
                                 SELECT referencia, vinculoativo3112, tipovinculo, escolaridade_2006_atual as escolaridade, sexotrabalhador, racacor, vlremdeznm as vlremundezembronom, vlremdezsm as vlremundezembrosm, tiposal as tiposalario, tempoemprego, qtdhoracontr, vl_salario_contrato as vlsalariocontratual, cbo2002 as cboocupacao2002, cnae20subclasse, idade, null as indtrabintermitente  FROM rais_id.vinc_2014 WHERE municipio = 530010 and vinculoativo3112 = 1
                                 union all
                                 SELECT referencia, vinculoativo3112, tipovinculo, escolaridade_2006_atual as escolaridade, sexotrabalhador, racacor, vlremdeznm as vlremundezembronom, vlremdezsm as vlremundezembrosm, tiposal as tiposalario, tempoemprego, qtdhoracontr, vl_salario_contrato as vlsalariocontratual, cbo2002 as cboocupacao2002, cnae20subclasse, idade, null as indtrabintermitente  FROM rais_id.vinc_2015 WHERE municipio = 530010 and vinculoativo3112 = 1
                                 union all
                                 SELECT referencia, vinculoativo3112, tipovinculo, escolaridade_2006_atual as escolaridade, sexotrabalhador, racacor, vlremdeznm as vlremundezembronom, vlremdezsm as vlremundezembrosm, tiposal as tiposalario, tempoemprego, qtdhoracontr, vl_salario_contrato as vlsalariocontratual, cbo2002 as cboocupacao2002, cnae20subclasse, idade, null as indtrabintermitente  FROM rais_id.vinc_2016 WHERE municipio = 530010 and vinculoativo3112 = 1
                                 union all
                                 SELECT referencia, vinculoativo3112, tipovinculo, escolaridade_2006_atual as escolaridade, sexotrabalhador, racacor, vlremdeznm as vlremundezembronom, vlremdezsm as vlremundezembrosm, tiposal as tiposalario, tempoemprego, qtdhoracontr, vl_salario_contrato as vlsalariocontratual, cbo2002 as cboocupacao2002, cnae20subclasse, idade, null as indtrabintermitente  FROM rais_id.vinc_2017 WHERE municipio = 530010 and vinculoativo3112 = 1
                                 union all
                                 SELECT referencia, vinculoativo3112, tipovinculo, escolaridade_2006_atual as escolaridade, sexotrabalhador, racacor, vlremdeznm as vlremundezembronom, vlremdezsm as vlremundezembrosm, tiposal as tiposalario, tempoemprego, qtdhoracontr, vl_salario_contrato as vlsalariocontratual, cbo2002 as cboocupacao2002, cnae20subclasse, idade, null as indtrabintermitente  FROM rais_id.vinc_2018 WHERE municipio = 530010 and vinculoativo3112 = 1
                                 union all
                                 SELECT referencia, vinculoativo3112, tipovinculo, escolaridade_2006_atual as escolaridade, sexotrabalhador, racacor, vlremdeznm as vlremundezembronom, vlremdezsm as vlremundezembrosm, tiposal as tiposalario, tempoemprego, qtdhoracontr, vl_salario_contrato as vlsalariocontratual, cbo2002 as cboocupacao2002, cnae20subclasse, idade, null as indtrabintermitente  FROM rais_id.vinc_2019 WHERE municipio = 530010 and vinculoativo3112 = 1
                                 union all
                                 SELECT referencia, vinculoativo3112, tipovinculo, escolaridade_2006_atual as escolaridade, sexotrabalhador, racacor, vlremdeznm as vlremundezembronom, vlremdezsm as vlremundezembrosm, tiposal as tiposalario, tempoemprego, qtdhoracontr, vl_salario_contrato as vlsalariocontratual, cbo2002 as cboocupacao2002, cnae20subclasse, idade, null as indtrabintermitente  FROM rais_id.vinc_2020 WHERE municipio = 530010 and vinculoativo3112 = 1
                                 union all
                                 SELECT referencia, vinculoativo3112, tipovinculo, escolaridade_2006_atual as escolaridade, sexotrabalhador, racacor, vlremdeznm as vlremundezembronom, vlremdezsm as vlremundezembrosm, tiposal as tiposalario, tempoemprego, qtdhoracontr, vl_salario_contrato as vlsalariocontratual, cbo2002 as cboocupacao2002, cnae20subclasse, idade, null as indtrabintermitente  FROM rais_id.vinc_2021 WHERE municipio = 530010 and vinculoativo3112 = 1")

                      
# Limpeza inpc inicial ----

dados<-as.data.table(dados)

serie_inpc = serie_inpc[serie_inpc$ano %in% 2010:2021,]

serie_inpc = aggregate(serie_inpc$inpc, list(referencia = serie_inpc$ano), function(x) (prod(1 + x)))

serie_inpc$inpc_acum = rev(cumprod(rev(serie_inpc$x)))

names(serie_inpc)[[2]] = 'inpc_anual'

# Limpa base ----
## Une base com inpc ----
dados = merge(dados, serie_inpc, all.x = TRUE)

## Filtra base ----
dados = dados[dados$vlremundezembrosm >= 0.5 & dados$vlremundezembrosm <= 200,]

## Calcula novas variaveis ----
dados$salario_dez_defl = dados$vlremundezembronom * dados$inpc_acum
dados$horas_mensais = dados$qtdhoracontr*4
dados$salario_hora = ifelse(dados$horas_mensais == 0,
                            NA_real_,
                            dados$salario_dez_defl/dados$horas_mensais)

## Filtra base de dados
dados = dados[dados$qtdhoracontr > 10 & dados$idade >= 18,]

## Dummys cbos
dados$cbo_tec_em_complet = ifelse(dados$cboocupacao2002 %in% cbotecnica_nivel_medio$cbo_em & dados$escolaridade %in% c(7:11) & dados$tipovinculo!='55', 1,0)
dados$cbo_tec_sup = ifelse(dados$cboocupacao2002 %in% cbotecnica_nivel_superior$cbo_superior & dados$escolaridade %in% c(9:11) & dados$tipovinculo!='55', 1,0)
dados$cbo_tec = ifelse(dados$cbo_tec_em_complet ==1 | dados$cbo_tec_sup==1, 1,0)

### Dummy vinculo

dados$celetistas = ifelse(dados$tipovinculo %in% c(10,15,20,25,60,65,70,75), 1,0)
dados$estatutarios = ifelse(dados$tipovinculo %in% c(30,31,35), 1,0)
dados$aprendiz = ifelse(dados$tipovinculo=='55', 1,0)
dados$outros = ifelse(dados$tipovinculo %in% c(40,50,80,90,95,96,97,-1), 1, 0)

### Dummy escolaridade

dados$medio_incompleto = ifelse(dados$escolaridade %in% c(2,3,4,5,6), 1,0)
dados$medio_completo = ifelse(dados$escolaridade %in% c(7,8), 1,0)
dados$superior_completo = ifelse(dados$escolaridade %in% c(9,10,11), 1, 0)
dados$analfabeto = ifelse(dados$escolaridade=='1', 1,0)

### retirando da base os vínculos em ocupações protegidas (militares) ###

cbos_protegidas = ocupacoes_protegidas$cbo_protegidas[!is.na(ocupacoes_protegidas$cbo_protegidas)]

dados = dados[!dados$cboocupacao2002 %in% cbos_protegidas,]


### Dummy eixo ----
dados$eixo_amb_saude_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo de Ambiente e Saúde`$`Eixo de Ambiente e Saúde` & dados$cbo_tec_em_complet == 1, 1,0)

dados$eixo_conteprocessos_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo de Controle e Processos Industriais`$`Eixo de Controle e Processos Industriais` & dados$cbo_tec_em_complet == 1, 1, 0)

dados$eixo_desedusoc_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo de Desenvolvimento Educacional e Social`$`Eixo de Desenvolvimento Educacional e Social` & dados$cbo_tec_em_complet == 1, 1,0)

dados$eixo_negocios_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo de Gestão e Negócios`$`Eixo de Gestão e Negócios` & dados$cbo_tec_em_complet == 1,1 ,0)

dados$eixo_infoecomunic_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo de Informação e Comunicação`$`Eixo de Informação e Comunicação` & dados$cbo_tec_em_complet == 1, 1, 0)

dados$eixo_infraestrutura_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo de Infraestrutura`$`Eixo de Infraestrutura` & dados$cbo_tec_em_complet == 1, 1, 0)

dados$eixo_prodaliment_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo de Produção Alimentícia`$`Eixo de Produção Alimentícia` & dados$cbo_tec_em_complet == 1, 1, 0)

dados$eixo_prodcult_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo de Produção Cultural e Design`$`Eixo de Produção Cultural e Design` & dados$cbo_tec_em_complet == 1, 1, 0)

dados$eixo_prodindust_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo de Produção Industrial`$`Eixo de Produção Industrial` & dados$cbo_tec_em_complet == 1, 1, 0)

dados$eixo_recnaturais_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo de Recursos Naturais`$`Eixo de Recursos Naturais` & dados$cbo_tec_em_complet == 1, 1, 0)

dados$eixo_seguranca_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo de Segurança`$`Eixo de Segurança` & dados$cbo_tec_em_complet == 1, 1, 0)

dados$eixo_hospelazer_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo de Turismo, Hospitalidade e Lazer`$`Eixo de Turismo, Hospitalidade e Lazer` & dados$cbo_tec_em_complet == 1, 1, 0)

dados$eixo_militar_em = ifelse(dados$cboocupacao2002 %in% eixos$`Eixo Militar`$`Eixo Militar` & dados$cbo_tec_em_complet == 1, 1, 0)

### Dummy eixo superior ----
dados$eixo_ambesaude_sup = ifelse(dados$cboocupacao2002 %in% eixos_superior$`Ambiente_saude`$`Ambiente_saude` & dados$cbo_tec_sup == 1, 1,0)

dados$eixo_conteprocessos_sup = ifelse(dados$cboocupacao2002 %in% eixos_superior$`Controle e Processos Industriais`$`Controle e Processos Industriais` & dados$cbo_tec_sup == 1, 1, 0)

dados$eixo_negocios_sup = ifelse(dados$cboocupacao2002 %in% eixos_superior$`gestao_neg`$`gestao_neg` & dados$cbo_tec_sup == 1,1 ,0)

dados$eixo_infoecomunic_sup = ifelse(dados$cboocupacao2002 %in% eixos_superior$`info_comu`$`info_comu` & dados$cbo_tec_sup == 1, 1, 0)

dados$eixo_infraestrutura_sup = ifelse(dados$cboocupacao2002 %in% eixos_superior$`Infraestrutura`$`Infraestrutura` & dados$cbo_tec_sup == 1, 1, 0)

dados$eixo_prodaliment_sup = ifelse(dados$cboocupacao2002 %in% eixos_superior$`prod_alim`$`prod_alim` & dados$cbo_tec_sup == 1, 1, 0)

dados$eixo_prodcult_sup = ifelse(dados$cboocupacao2002 %in% eixos_superior$`prod_cul_design`$`prod_cul_design` & dados$cbo_tec_sup == 1, 1, 0)

dados$eixo_prodindust_sup = ifelse(dados$cboocupacao2002 %in% eixos_superior$`prod_ind`$`prod_ind` & dados$cbo_tec_sup == 1, 1, 0)

dados$eixo_recnaturais_sup = ifelse(dados$cboocupacao2002 %in% eixos_superior$`Recursos Naturais`$`Recursos Naturais` & dados$cbo_tec_sup == 1, 1, 0)

dados$eixo_seguranca_sup = ifelse(dados$cboocupacao2002 %in% eixos_superior$`seguranca`$`seguranca` & dados$cbo_tec_sup == 1, 1, 0)

dados$eixo_hospelazer_sup = ifelse(dados$cboocupacao2002 %in% eixos_superior$`Tur_hosp_lazer`$`Tur_hosp_lazer` & dados$cbo_tec_sup == 1, 1, 0)

dados$eixo_militar_sup = ifelse(dados$cboocupacao2002 %in% eixos_superior$`Eixo Militar`$`Eixo Militar` & dados$cbo_tec_sup == 1, 1, 0)


##############################################################################################

# tabela mmt-vinculos-ano e dados referentes a cbo e cnae

dados$cboocupacao2002 <- as.character(dados$cboocupacao2002)
dados$cnae20subclasse <- as.character(dados$cnae20subclasse)

dados[, cnae := as.integer(stringr::str_pad(cnae20subclasse, width = 7, side = 'left', pad = '0'))  %/% 1e5]

dados[, cbo := as.integer(stringr::str_pad(stringr::str_remove(cboocupacao2002, '-'), width = 6, side = 'left', pad = '0'))  %/% 1e5]

dados[, cbo := fcase(
  cbo == 0, 'Membros das forças armadas, policiais e bombeiros militares',
  cbo == 1, 'Membros superiores do poder público, dirigentes de organizações de interesse público e de empresas, gerentes',
  cbo == 2, 'Profissionais das ciências e das artes',
  cbo == 3, 'Técnicos de nivel médio',
  cbo == 6, 'Trabalhadores agropecuários, florestais e da pesca',
  cbo == 7, 'Trabalhadores da produção de bens e serviços industriais',
  cbo == 8, 'Trabalhadores da produção de bens e serviços industriais',
  cbo == 4, 'Trabalhadores de serviços administrativos',
  cbo == 5, 'Trabalhadores dos serviços, vendedores do comércio em lojas e mercados',
  cbo == 9, 'Trabalhadores em serviços de reparação e manutenção'
)]

dados[, cnae := fcase(
  cnae %in% 1:3, 'AGRICULTURA, PECUÁRIA, PRODUÇÃO FLORESTAL, PESCA E AQÜICULTURA',
  cnae %in% 5:9, 'INDÚSTRIAS EXTRATIVAS',
  cnae %in% 10:33, 'INDÚSTRIAS DE TRANSFORMAÇÃO',
  cnae %in% 35, 'ELETRICIDADE E GÁS',
  cnae %in% 36:39, 'ÁGUA, ESGOTO, ATIVIDADES DE GESTÃO DE RESÍDUOS E DESCONTAMINAÇÃO',
  cnae %in% 41:43, "CONSTRUÇÃO",
  cnae %in% 45:47, 'COMÉRCIO; REPARAÇÃO DE VEÍCULOS AUTOMOTORES E MOTOCICLETAS',
  cnae %in% 49:53, 'TRANSPORTE, ARMAZENAGEM E CORREIO',
  cnae %in% 55:56, 'ALOJAMENTO E ALIMENTAÇÃO',
  cnae %in% 58:63, 'INFORMAÇÃO E COMUNICAÇÃO',
  cnae %in% 64:66, 'ATIVIDADES FINANCEIRAS, DE SEGUROS E SERVIÇOS RELACIONADOS',
  cnae %in% 68, 'ATIVIDADES IMOBILIÁRIAS',
  cnae %in% 69:75, 'ATIVIDADES PROFISSIONAIS, CIENTÍFICAS E TÉCNICAS',
  cnae %in% 77:82, 'ATIVIDADES ADMINISTRATIVAS E SERVIÇOS COMPLEMENTARES',
  cnae %in% 84, 'ADMINISTRAÇÃO PÚBLICA, DEFESA E SEGURIDADE SOCIAL',
  cnae %in% 85, 'EDUCAÇÃO',
  cnae %in% 86:88, 'SAÚDE HUMANA E SERVIÇOS SOCIAIS',
  cnae %in% 90:93, 'ARTES, CULTURA, ESPORTE E RECREAÇÃO',
  cnae %in% 94:96, 'OUTRAS ATIVIDADES DE SERVIÇOS',
  cnae %in% 97, 'SERVIÇOS DOMÉSTICOS',
  cnae %in% 99, 'ORGANISMOS INTERNACIONAIS E OUTRAS INSTITUIÇÕES EXTRATERRITORIAIS',
  default = 'erro'
)]

dados[, tipo_educ := fcase(
  cbo_tec == 1, "Técnico",
  superior_completo == 1 & cbo_tec != 1, 'Superior',
  medio_completo == 1 & cbo_tec != 1, 'Médio',
  default = 'Outros'
)]

dados$tipo_educ = factor(dados$tipo_educ, levels = c("Outros", "Médio", "Técnico", "Superior"), ordered = TRUE)

dados[, tipo_emprego := fcase(
  estatutarios  == 1, "Estatutário",
  celetistas  == 1, 'Celetista',
  default = 'Outros'
)]


#######salvar os dados na base rais-panorama-2021 (a base de todas as análises)

data.table::fwrite(dados, file = 'dados/rais-panorama-2021.csv', sep = ';')


# Tabela de vínculos técnicos e não técnicos
## Definindo tecnicos nao tecnicos
vinculos_ano = rbind(
  dados[, .(vinculos = .N), by = .(cbo_tec, referencia, tipo_emprego)][, cbo_tec := ifelse(cbo_tec == 1, 'Técninas', 'Não Técnicas')],
  dados[, .(vinculos = .N), by = .(cbo_tec, referencia)][, `:=`(cbo_tec = ifelse(cbo_tec == 1, 'Técninas', 'Não Técnicas'), tipo_emprego = "Total")])


### salvar a tabela

readr::write_excel_csv2(vinculos_ano, 'dados/mmt-vinculos-ano-2021.csv')









